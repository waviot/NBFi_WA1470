#include "zcode.h"


const uint8_t n[4][128] =
{
    {0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127},
    {104,52,43,96,31,7,71,78,58,37,93,25,125,85,42,111,6,95,72,117,27,51,63,84,91,35,120,26,97,45,110,70,1,28,86,114,53,67,12,127,40,101,73,94,115,61,20,126,3,46,92,116,9,56,87,77,109,44,65,54,100,118,2,34,21,41,76,14,69,124,90,18,103,48,113,36,0,81,13,62,24,38,105,68,15,75,88,50,122,29,83,102,8,16,108,23,32,49,99,112,19,55,89,11,107,82,47,98,22,30,60,80,66,121,10,57,17,39,79,4,64,123,33,59,106,74,5,119},
    {26,10,105,48,38,84,76,57,23,125,115,3,106,33,77,99,71,113,22,1,44,87,8,31,111,96,2,42,70,81,13,93,122,37,114,88,63,107,50,40,82,116,68,6,127,16,51,73,61,83,46,0,126,104,78,67,41,119,28,11,56,47,4,21,52,66,15,98,24,7,30,91,112,35,55,124,64,5,95,32,49,9,85,65,43,18,92,36,12,86,118,60,25,72,53,80,123,45,58,102,110,120,89,34,17,75,94,27,100,62,20,39,108,90,69,117,97,59,79,109,101,19,121,54,29,14,74,103},
    {0,93,104,36,87,125,23,97,44,107,11,3,70,35,60,77,29,84,6,91,126,15,76,56,4,89,115,99,43,22,122,16,105,55,2,113,78,51,63,14,120,102,8,19,68,111,86,47,64,32,121,72,59,108,96,80,25,67,118,12,58,127,20,90,9,37,103,53,62,69,85,10,110,34,100,119,39,73,1,83,48,112,30,54,65,45,5,123,101,26,88,18,46,95,40,109,7,27,57,66,116,38,75,92,21,52,61,28,106,114,94,33,17,79,42,71,124,50,82,13,31,41,117,74,98,81,24,49}
};

const uint8_t n_e[4][144] =
{
    {0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143},
    {128,96,64,32,0,113,81,49,17,130,98,66,34,2,115,83,51,19,132,100,68,36,4,117,85,53,21,134,102,70,38,6,119,87,55,23,136,104,72,40,8,121,89,57,25,138,106,74,42,10,123,91,59,27,140,108,76,44,12,125,93,61,29,142,110,78,46,14,127,95,63,31,112,80,48,16,129,97,65,33,1,114,82,50,18,131,99,67,35,3,116,84,52,20,133,101,69,37,5,118,86,54,22,135,103,71,39,7,120,88,56,24,137,105,73,41,9,122,90,58,26,139,107,75,43,11,124,92,60,28,141,109,77,45,13,126,94,62,30,143,111,79,47,15},
    {93,136,34,77,120,18,61,104,2,45,88,131,29,72,115,13,56,99,142,40,83,126,24,67,110,8,51,94,137,35,78,121,19,62,105,3,46,89,132,30,73,116,14,57,100,143,41,84,127,25,68,111,9,52,95,138,36,79,122,20,63,106,4,47,90,133,31,74,117,15,58,101,42,85,128,26,69,112,10,53,96,139,37,80,123,21,64,107,5,48,91,134,32,75,118,16,59,102,0,43,86,129,27,70,113,11,54,97,140,38,81,124,22,65,108,6,49,92,135,33,76,119,17,60,103,1,44,87,130,28,71,114,12,55,98,141,39,82,125,23,66,109,7,50},
    {2,8,14,20,26,32,38,44,50,56,62,68,74,80,86,92,98,104,110,116,122,128,134,140,1,7,13,19,25,31,37,43,49,55,61,67,73,79,85,91,97,103,109,115,121,127,133,139,0,6,12,18,24,30,36,42,48,54,60,66,72,78,84,90,96,102,108,114,120,126,132,138,5,11,17,23,29,35,41,47,53,59,65,71,77,83,89,95,101,107,113,119,125,131,137,143,4,10,16,22,28,34,40,46,52,58,64,70,76,82,88,94,100,106,112,118,124,130,136,142,3,9,15,21,27,33,39,45,51,57,63,69,75,81,87,93,99,105,111,117,123,129,135,141}
};

void ZCODE_Append(uint8_t * src_buf, uint8_t * dst_buf, _Bool parity)
{
    uint8_t b0;     
    uint8_t b1;     
    uint8_t bprev;  
    uint8_t res;    

    uint8_t code[4][8]={{0,0,0,0,0,0,0,0},{0,0,0,0,0,0,0,0},{0,0,0,0,0,0,0,0},{0,0,0,0,0,0,0,0}};

    for(int j=0; j<4; j++)
    {
        for(uint8_t i=0; i<64; i++) 
        {
            b0      = (src_buf[ n[j][ i ]  /8] << ( n[j][ i ]  %8)) & 0x80;
            b1      = (src_buf[ n[j][64+i] /8] << ( n[j][64+i] %8)) & 0x80;
            bprev   = (code[j][   (i-1)    /8] << (   (i-1)    %8)) & 0x80;
            res     =  b0 ^ b1 ^ bprev;
            code[j][i/8] |= res >> (i%8);
        }
    }

    for(int i=0; i<8;i++)
    {
        dst_buf[i]      = (code[0][i] & (parity ? 0xAA : 0x55)) | (code[1][i] & (parity ? 0x55 : 0xAA));
        dst_buf[i+8]    = (code[2][i] & (parity ? 0xAA : 0x55)) | (code[3][i] & (parity ? 0x55 : 0xAA));
    }
}

void ZCODE_E_Append(uint8_t * src_buf, uint8_t * dst_buf, _Bool parity)
{
    uint8_t b0;     
    uint8_t b1;     
    uint8_t bprev;  
    uint8_t res;    


    uint8_t code[4][9]={{0,0,0,0,0,0,0,0,0},{0,0,0,0,0,0,0,0,0},{0,0,0,0,0,0,0,0,0},{0,0,0,0,0,0,0,0,0}};

    for(int j=0; j<4; j++)
    {
        for(uint8_t i=0; i<72; i++) 
        {
            b0      = (src_buf[ n_e[j][ i ]  /8] << ( n_e[j][ i ]  %8)) & 0x80;
            b1      = (src_buf[ n_e[j][72+i] /8] << ( n_e[j][72+i] %8)) & 0x80;
            bprev   = (code[j][   (i-1)    /8] << (   (i-1)    %8)) & 0x80;
            res     =  b0 ^ b1 ^ bprev;
            code[j][i/8] |= res >> (i%8);
        }
    }

    for(int i=0; i<9;i++)
    {
        dst_buf[i]      = (code[0][i] & (parity ? 0xAA : 0x55)) | (code[1][i] & (parity ? 0x55 : 0xAA));
        dst_buf[i+9]    = (code[2][i] & (parity ? 0xAA : 0x55)) | (code[3][i] & (parity ? 0x55 : 0xAA));
    }
}
